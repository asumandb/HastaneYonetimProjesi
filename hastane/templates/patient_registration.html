{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <style>
    .card-modern { border: none; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
    .card-modern .card-header { background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%); color: #fff; padding: 10px 16px; }
    .card-modern .card-header .title { font-weight: 600; letter-spacing: .2px; font-size: 1rem; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .table-modern { margin: 0; }
    .table-modern thead th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 1; }
    .table-modern tbody tr:hover { background-color: #f6f9ff; }
    .search-input { max-width: 220px; }
    .no-wrap { white-space: nowrap; }
    .btn-compact { padding: .25rem .5rem; line-height: 1.2; display: inline-flex; align-items: center; }
    .field-label { font-size: .85rem; font-weight: 600; margin: 6px 0 2px; color: #333; }
    /* Confirm modal */
    #confirmDeleteModal { min-width:320px; max-width:380px; border:1px solid #ccc; padding:18px; background:#fff; position:fixed; top:28%; left:50%; transform:translate(-50%, 0); z-index:1000; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15); display:none; }
    #confirmDeleteModal .title { font-weight:700; margin-bottom:6px; }
    #confirmDeleteModal .text { margin: 8px 0 14px; }
    </style>

    <div id="successMsg" style="display:none;" class="alert alert-success mt-3">Başarıyla kaydedildi!</div>

    <div class="card card-modern mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="title">Hasta Kayıtları</div>
            <div class="toolbar">
                <input id="tableSearch" type="text" class="form-control form-control-sm search-input" placeholder="Tabloda ara...">
                <button id="addPatientBtn" type="button" class="btn btn-light btn-sm btn-compact no-wrap">Hasta Ekle</button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="patientsTable" class="table table-hover align-middle table-modern">
                <thead>
                    <tr>
                        <th>Ad</th>
                        <th>Soyad</th>
                        <th>Doğum Tarihi</th>
                        <th>TC Kimlik No</th>
                        <th>E-posta</th>
                        <th>Telefon</th>
                        <th>Giriş Tarihi</th>
                        <th>Çıkış Tarihi</th>
                        <th style="width: 170px;">İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Hastalar buraya gelecek -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Overlays and Modals -->
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:999;"></div>

<!-- Hasta Ekle/Düzenle Modalı -->
<div id="patientModal" style="display:none; min-width:320px; max-width:350px; border:1px solid #ccc; padding:24px 18px 18px 18px; background:#fff; position:fixed; top:20%; left:50%; transform:translate(-50%, 0); z-index:1000; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.15);">
    <input type="hidden" id="patientId">
    <div class="mb-2">
        <div class="field-label">Ad</div>
        <input type="text" id="firstName" placeholder="Ad" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">Soyad</div>
        <input type="text" id="lastName" placeholder="Soyad" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">E-posta</div>
        <input type="email" id="email" placeholder="E-posta" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">Telefon</div>
        <input type="text" id="phone" placeholder="Telefon" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">TC Kimlik No</div>
        <input type="text" id="tcNumber" placeholder="TC Kimlik No" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">Doğum Tarihi</div>
        <input type="date" id="dateOfBirth" placeholder="Doğum Tarihi" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">Giriş Tarihi</div>
        <input type="date" id="entryDate" class="form-control">
    </div>
    <div class="mb-2">
        <div class="field-label">Çıkış Tarihi</div>
        <input type="date" id="exitDate" class="form-control">
    </div>
    <div style="text-align:right;">
        <button id="savePatientBtn" type="button" class="btn btn-success">Kaydet</button>
        <button id="cancelPatientBtn" type="button" class="btn btn-danger">İptal</button>
    </div>
</div>

<!-- Silme Onay Modalı -->
<div id="confirmDeleteModal">
    <div class="title">Silme Onayı</div>
    <div id="confirmDeleteText" class="text">Silmek istediğinize emin misiniz?</div>
    <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <button id="confirmDeleteNo" type="button" class="btn btn-secondary btn-sm">Vazgeç</button>
        <button id="confirmDeleteYes" type="button" class="btn btn-danger btn-sm">Sil</button>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type)) && !this.crossDomain) {
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
        }
    }
});

function loadPatients() {
    $.get('/patients/', function(data) {
        let rows = '';
        data.patients.forEach(function(p) {
            rows += `<tr>
                <td>${p.name}</td>
                <td>${p.surname}</td>
                <td>${p.date_of_birth || ''}</td>
                <td>${p.tc_number || ''}</td>
                <td>${p.email || ''}</td>
                <td>${p.phone || ''}</td>
                <td>${p.entry_date || ''}</td>
                <td>${p.exit_date || ''}</td>
                <td>
                    <button class="editBtn btn btn-outline-primary btn-sm me-1" 
                        data-id="${p.id}" 
                        data-name="${p.name}" 
                        data-surname="${p.surname}" 
                        data-email="${p.email}" 
                        data-phone="${p.phone}" 
                        data-tc_number="${p.tc_number}" 
                        data-date_of_birth="${p.date_of_birth}"
                        data-entry_date="${p.entry_date || ''}"
                        data-exit_date="${p.exit_date || ''}">Düzenle</button>
                    <button class="deleteBtn btn btn-outline-danger btn-sm" data-id="${p.id}" data-name="${p.name} ${p.surname}">Sil</button>
                </td>
            </tr>`;
        });
        $('#patientsTable tbody').html(rows);
    });
}

function showModal(patient) {
    if (patient) {
        $('#patientId').val(patient.id);
        $('#firstName').val(patient.name);
        $('#lastName').val(patient.surname);
        $('#email').val(patient.email);
        $('#phone').val(patient.phone);
        $('#tcNumber').val(patient.tc_number);
        $('#dateOfBirth').val(patient.date_of_birth);
        $('#entryDate').val(patient.entry_date);
        $('#exitDate').val(patient.exit_date);
    } else {
        $('#patientId').val('');
        $('#firstName').val('');
        $('#lastName').val('');
        $('#email').val('');
        $('#phone').val('');
        $('#tcNumber').val('');
        $('#dateOfBirth').val('');
        $('#entryDate').val('');
        $('#exitDate').val('');
    }
    $('#modalOverlay').fadeIn(100);
    $('#patientModal').fadeIn(200);
}

function hideModal() {
    $('#patientModal').fadeOut(150);
    $('#modalOverlay').fadeOut(100);
}

// Confirm delete modal helpers
let pendingDeleteId = null;
function showConfirmDelete(name, id) {
    pendingDeleteId = id;
    $('#confirmDeleteText').text(`Silmek istediğinize emin misiniz? (${name})`);
    $('#modalOverlay').fadeIn(100);
    $('#confirmDeleteModal').fadeIn(180);
}
function hideConfirmDelete() {
    pendingDeleteId = null;
    $('#confirmDeleteModal').fadeOut(120);
    $('#modalOverlay').fadeOut(100);
}

$(document).ready(function() {
    loadPatients();

    $('#addPatientBtn').off('click').on('click', function(e) {
        e.preventDefault();
        showModal(null);
    });

    $('#cancelPatientBtn').off('click').on('click', function(e) {
        e.preventDefault();
        hideModal();
    });

    $('#modalOverlay').off('click').on('click', function() {
        // Kapatılmakta olan modalı belirlemek için her ikisini de sakla
        hideModal();
        hideConfirmDelete();
    });

    $('#confirmDeleteNo').off('click').on('click', function() {
        hideConfirmDelete();
    });

    $('#confirmDeleteYes').off('click').on('click', function() {
        if (!pendingDeleteId) return;
        $.ajax({
            url: `/patients/${pendingDeleteId}/delete/`,
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            success: function(resp) {
                hideConfirmDelete();
                loadPatients();
            }
        });
    });

    $('#savePatientBtn').off('click').on('click', function(e) {
        e.preventDefault();
        var patientId = $('#patientId').val();
        var url = '/patients/';
        var type = 'POST';
        if (patientId) {
            url = `/patients/${patientId}/update/`;
            type = 'POST';
        }
        $.ajax({
            url: url,
            type: type,
            data: JSON.stringify({
                name: $('#firstName').val(),
                surname: $('#lastName').val(),
                email: $('#email').val(),
                phone: $('#phone').val(),
                tc_number: $('#tcNumber').val(),
                date_of_birth: $('#dateOfBirth').val(),
                entry_date: $('#entryDate').val(),
                exit_date: $('#exitDate').val()
            }),
            contentType: 'application/json',
            success: function(response) {
                $('#successMsg').show().delay(2000).fadeOut();
                hideModal();
                loadPatients();
            }
        });
    });

    $(document).on('click', '.editBtn', function() {
        const patient = {
            id: $(this).data('id'),
            name: $(this).data('name'),
            surname: $(this).data('surname'),
            email: $(this).data('email'),
            phone: $(this).data('phone'),
            tc_number: $(this).data('tc_number'),
            date_of_birth: $(this).data('date_of_birth'),
            entry_date: $(this).data('entry_date'),
            exit_date: $(this).data('exit_date')
        };
        showModal(patient);
    });

    $(document).on('click', '.deleteBtn', function() {
        const id = $(this).data('id');
        const name = $(this).data('name');
        showConfirmDelete(name, id);
    });

    // Basit canlı arama filtresi
    $(document).on('input', '#tableSearch', function() {
        const q = $(this).val().toString().toLowerCase();
        $('#patientsTable tbody tr').each(function() {
            const rowText = $(this).text().toLowerCase();
            $(this).toggle(rowText.indexOf(q) !== -1);
        });
    });
});
</script>
{% endblock %}
</body>